---
title: "3D Plotly test code"
author: "Maryann Tan"
date: "2/22/2021"
output: html_document
---

```{r rmarkdown setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message=FALSE, warning=FALSE, error=TRUE)
```

```{r}
```{r preamble, message=FALSE, warning=FALSE, error=FALSE, echo=FALSE, results='hide'}
rm(list=ls())
library(bookdown)       # r markdown references to figures, tables, sections regardless of output format
library(tidyverse)      # There is only one universe
library(magrittr)       # Pipes!
library(stringi)

library(knitr) 
library(kableExtra)     # more control over table formatting

library(lme4)           # mixed-effects analyses
library(lmerTest)       # p-values in LMMs
library(broom.mixed)    # easy extraction of information from LMMs
library(sjPlot)         # HTML tables of mixed models
library(emmeans)        # simple effects in LMMs
library(rms)

library(cowplot)        # multi-plot figures
library(plotly)         # 3D plotting 
library(shiny)          # tabs
library(ggpubr)
library(gridExtra)

library(assertthat)
# devtools::install_github('kleinschmidt/daver')
library(daver)
# devtools::install_github("kleinschmidt/phondisttools")
library(phondisttools)
# devtools::install_github("hlplab/MVBeliefUpdatr")
library(MVBeliefUpdatr)
```
```



```{r functions to plot-ideal-observers-results-3D}
plot_IO_test = function(
  .data.IO, 
  .data.test = NULL,
  language, 
  cues,
  show.difference = FALSE # Should the difference between native and non-native posterior be plotted?
) {
  message("plot_IO() currently expects three cues: vowel, closure, burst (corrected or uncorrected).")
  
  # If .data.test contains more than one instance per unique combination of stimulus & model, summarize it down to one observation 
  # per stimulus & model
  .data.test %<>% 
    filter(Model.Group.matchesParticipant.Group == "yes") %>%
    group_by(NativeLanguage, Item.Word, Item.WordID, Item.MinimalPair, Model.Group, Sound) %>%
    summarise_at(c(cues, "Model.Posterior.Intended"), first)
  
  # If difference should be plotted instead
  if (show.difference) {
    .data.test %<>%
      pivot_wider(
        names_from = Model.Group,
        values_from = Model.Posterior.Intended
      ) %>%
      # Using difference. Could use ratio instead
      mutate(Model.Posterior.Intended.Difference = `/d/-exposure` - control)
  }
  # Unnest data if that hasn't already happened
  if ("ellipse" %in% names(.data.IO)) .data.IO %<>%
    unnest(ellipse)
  
  axes = get_axes(.data.IO, cues)
  
  if (!is.null(.data.test)) {
    # Plot difference ...
    if (show.difference) {
      p = plot_ly(
        data = .data.test %>%
          filter(NativeLanguage %in% language) %>%
          mutate(
            vowel = !! rlang::sym(cues[1]),
            closure = !! rlang::sym(cues[2]),
            burst = !! rlang::sym(cues[3])),
        # x= ~vowel,
        # y= ~closure,
        # z= ~burst,
        # marker = list(color = ~Model.Posterior.Intended.Difference, 
        #               colorscale = 'Rdbu', 
        #               cmin = -1, 
        #               cmax = 1, 
        #               showscale = T),
        symbol= ~Sound,
        symbols = shapes.Category,
        #opacity = .7,
        showlegend = T,
        type="scatter3d", 
        mode="markers") %>% 
        add_markers(x= ~vowel,
                  y= ~closure,
                  z= ~burst,
                  marker = list(color = ~Model.Posterior.Intended.Difference,
                                cauto = TRUE,
                                autocolorscale = FALSE,
                                colorscale = list(c(0,'rgba(9, 1, 95,0.7)'),
                                                  list(0.5,'rgba(236, 237, 231,0.7)'),
                                                  list(1,'rgba(235, 94, 11,0.7)')), 
                                cmin = -1,
                                cmid = 0,
                                cmax = 1,
                                colorbar = list(len = 0.5, title = 'Posterior prediction difference'),
                                line = list(colors = ~Sound, 
                                            width = 1), 
                                showscale = T))
    # ... or posterior by accent
    } else p = plot_ly(
      data = .data.test %>%
        filter(NativeLanguage %in% language) %>%
        mutate(
          vowel = !! rlang::sym(cues[1]),
          closure = !! rlang::sym(cues[2]),
          burst = !! rlang::sym(cues[3])),
      symbol= ~Sound,
      symbols = shapes.Category,
      frame= ~Model.Group,
      type="scatter3d", 
      mode="markers"
     ) %>% 
        add_markers(x= ~vowel,
                  y= ~closure,
                  z= ~burst, 
                  marker = list(
                     color= ~Model.Posterior.Intended,
                     cauto = F,
                     autocolorscale = F,
                     colorscale = list(c(0,'rgb(247, 239, 205)'), list(1,'rgb(128, 42,27)')),
                     cmin = 0,
                     cmax = 1,
                     colorbar = list(len = 0.7, title = 'Model posterior prediction'),
                     line = list(colors = ~Sound, width = 1)
        )) 
  } else p = plot_ly()
  
  p = p %>%
    # specify axis range to be held constant across plots
    layout(scene = list(xaxis = axes[[1]], yaxis = axes[[2]], zaxis = axes[[3]], aspectmode='cube')) 

  # Add ideal observer, or---if differences are to be shown---add color scale
  if (!show.difference) 
    p = plot_IO(.data.IO, language = language, .plot = p, cues = cues, alpha = .2, addSlider = T) 
  
  return(p)
}
```

```{r plot-3d-test-IO-English, fig.cap="(ref:plot-3d-test-IO-English)", fig.height=4.5, out.width="75%"}
plot_IO_test(d.IO, d.test.IO, language = "English", cues = selected_cues)
``` 


```{r plot-3d-test-IO-English-difference, fig.cap="(ref:plot-3d-test-IO-English-difference)", fig.height=4.5, out.width="75%"}
plot_IO_test(d.IO, d.test.IO, language = c("English"), cues = selected_cues, show.difference = T)

```.
